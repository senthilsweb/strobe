<div class="box widget">
    <h3>
        <i class="fa fa-list vm-fa-white"></i>&nbsp;Search</h3>
</div>
<div class="row-fluid">
    <%- partial('../partials/master-combo-single', {'fnPrefix' : 'Employee','api':'/Employee','ph': 'Employee'})%>
</div>
<div>&nbsp;</div>
<div class="row-fluid">
    <div class="span6">
        <input id="radio_button_week" type="radio" name="search" value="Week">Week</div>
    <div class="span6">
        <input id="radio_button_month" type="radio" name="search" value="Month" checked="checked">Month</div>
</div>
<div>&nbsp;</div>
<div class="row-fluid">
    <div class="span6">
        <div>
            <label class="control-label" for="txtsearchAttendanceDate">
                Month & Year</label>
            <div class="input-append date" date-start-view="1">
                <input id="txtsearchAttendanceDate" class="input-mini" type="text" placeholder="mm/yyyy" />
                <span class="add-on"><i class="fa fa-th"></i></span>
            </div>
        </div>
    </div>
    <div class="span1">
        &nbsp;</div>
</div>
<div class="row-fluid" id="divWeek">
    <div class="span12">
        <table class="table table-condensed" id="attendance_WeeklySearch">
        </table>
    </div>
</div>
<div class="box widget" id="divGageTitle">
    <h3>
        <i class="fa fa-list vm-fa-white"></i>&nbsp;Hours Clocked</h3>
</div>
<div class="row-fluid" id="divAttendanceJustGage">
    <div class="span12">
    </div>
</div>


<script id="tpl-attendanceSearch-list" type="text/x-jquery-tmpl">
    <tr>
    <td><i class="${icon}"></i><span class="${weekColor}">${weekCode}</span></td>
    <td><a class ='View' href='#' id="${weekId}">${weekValue}</a></td>   
    </tr>    
</script>
<script type="text/javascript">
    function SearchAttendance_Load() {
        //For Date plugin to display only month
        //$('.vm-month').datepicker({ format: "mm/yyyy", viewMode: 1, minViewMode: 1 });

        $('#txtsearchAttendanceDate').datepicker({ format: "mm/yyyy", viewMode: 1, minViewMode: 1 }).on('changeDate', function (ev) {
            $(this).blur();
            $(this).datepicker('hide');
        });
        $('input[type="radio"]').on("click", function () {
            $("#txtsearchAttendanceDate").val("");
            $("#attendanceDetails,#divGageTitle,#divAttendanceJustGage,#divAttendanceGrid,#divWeek").hide();
        });
        $("#txtsearchAttendanceDate").change(function (e) {
            if ($('#radio_button_month').is(':checked')) {
                var args = {};
                var monthselected = moment($("#txtsearchAttendanceDate").val().split('/')[0] + "-01-" + $("#txtsearchAttendanceDate").val().split('/')[1]).format("DD-MMM-YYYY");
                args.monthStart = moment(monthselected).startOf('month').format("DD-MMM-YYYY")
                args.monthEnd = moment(monthselected).endOf('month').format("DD-MMM-YYYY")
                args.action = "monthly";
                args.maxhrs = 180;
                $.Topic("Attendance_Details_Monthly").publish(args);
            }
            else {
                $("#divWeek").show();
                Search_AttendanceDate();
            }
        });

    }

    function Search_AttendanceDate() {
        //Empty the existing data source
        data = [];
        //get the user entered year
        var selDate = $("#txtsearchAttendanceDate").val();
        //if date selected is empty, set year as current year
        if (selDate == "") {
            //get the current date
            var d = new Date();
            //get the current year
            selYear = d.getFullYear();
            //get the current month
            selMonth = d.getMonth();
        } else {
            //get the selected year
            selYear = selDate.split("/")[1];
            //get the selected month
            selMonth = selDate.split("/")[0] - 1;
        }
        //get the weeks based on year
        var data = GetWeeksBasedOnMonthAndYear(selYear, selMonth);

        //Bind the data to the datatable depending on the criteria
        //Format of setTimeout is (functionname,delay,parameters if any)  
        setTimeout(Search_AttendanceDate_BindData, 0, data);
        return false;
    }

    function Search_AttendanceDate_BindData(data) {
        var details = [];
        _.each(data, function (item) {
            var data = {};
            data.weekCode = item[0];
            data.weekValue = item[1];
            data.weekId = item[2];
            //data.weekStartToEnd = moment(item[3]).format('DD/MM/YYYY') + "-" + moment(item[4]).format('DD/MM/YYYY');
            switch (item[0]) {
                case "W1":
                    data.icon = "fa fa-calendar icon-large attendance-green";
                    data.weekColor = "attendance-green";
                    break;
                case "W2":
                    data.icon = "fa fa-calendar icon-large attendance-red";
                    data.weekColor = "attendance-red";
                    break;
                case "W3":
                    data.icon = "fa fa-calendar icon-large attendance-blue";
                    data.weekColor = "attendance-blue";
                    break;
                case "W4":
                    data.icon = "fa fa-calendar icon-large attendance-yellow";
                    data.weekColor = "attendance-yellow";
                    break;
                default:
                    data.icon = "fa fa-calendar icon-large attendance-pink";
                    data.weekColor = "attendance-pink";
                    break;
            }
            details.push(data);
        });
        //before appending the template empty it
        $("#attendance_WeeklySearch").empty();
        $("#tpl-attendanceSearch-list").tmpl(details).appendTo("#attendance_WeeklySearch");

        //Attach event handlers                    
        $("#attendance_WeeklySearch").on("click", 'a', function () {
            var args = {};
            args.weekStartToEnd = ($(this)[0].text.split('-'));
            args.action = "weekly";
            args.maxhrs = 45;
            $.Topic("Attendance_Details_Weekly").publish(args);
        });
    }


    addLoadEvent(SearchAttendance_Load);
</script>