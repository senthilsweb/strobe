<%- console.log(title)%>

<div class="box widget">    
    <h3>
        <i class="fa fa-list vm-fa-white"></i>&nbsp;<%=title%>
        <button type="submit" class="btn btn-mini pull-right" style="margin-top: 1px;" id="<%=fnPrefix%>_Add_master"><i class="ion-plus"></i>&nbsp;Add</button>
    </h3>  
    <!--Search panel(start)-->
    <div class="row-fluid" id="<%=fnPrefix%>_Search">
        <%- partial('../partials/subpartials/master-search', {'fnPrefix' : fnPrefix, 'showComponent':'true'}) %>                   
   </div>
<!--Search panel(End)-->
    <!--Master List table(start)--> 
    <table class="table table-condensed" id="<%=fnPrefix%>pc-master-list">   
          
    </table>
    <div class="pagination"><ul id="pagination-demo"></ul></div>
    <!--Master List table(end)-->
</div>

<script id="tpl-master-list" type="text/x-jquery-tmpl">
    <tr>
        <td data-column-name="masterList">
            <i class="fa fa-pencil-square-o" data-id="${id}" data-action="edit" style="cursor:pointer"></i>
            <i class="fa fa-trash-o vm-fa-red" data-id="${id}" data-action="delete" style="cursor:pointer"></i>
            <a href="#" data-id="${id}" data-action="view">${name} &nbsp;</a>
            <i class="${statusClass} vm-dummy-trunk8" title="${title}" data-id="${id}"></i>
        </td>
    </tr>
</script>
<script type="text/javascript">
    console.log("Master List");     
    <%=fnPrefix%>MasterList = function() {
        //1) Click of Add new master
         $("#<%=fnPrefix%>_Add_master").click(function () {
                $.Topic("master-list-add-click").publish();
                return false;
        });
        //2) Subscribes for Events Search Button Click Event to clear the existing deatils
        $.Topic("<%=fnPrefix%>_Master_SearchButtonClick").subscribe(<%=fnPrefix%>Master_List_BindData);
        //3 load master table on page load    
             
        eval('<%=fnPrefix%>Master_List_BindData'+'()');
    }
    //----------------------------------------------------------------------
    addLoadEvent(<%=fnPrefix%>MasterList); 
    
    var <%=fnPrefix%>Master_List_BindData = function <%=fnPrefix%>Master_List_BindData(args){
         
         //For Progress bar during ajax call      
         $.Topic("LoadingImage").publish({ progress: "show", container: "<%=fnPrefix%>pc-master-list" });        
        //Ajax call in settimeout to show the progress bar otherwise in local the data will come very quick and one may not see the progressbar
        setTimeout(function () {
            var txtSearch = $("#txt<%=fnPrefix%>SearchName").val();
            var where = {};
            where.name = {};
            where.name.contains = txtSearch;
            console.log(JSON.stringify(where));
            
            var urlwithCriteria = location.origin + "<%=api%>"
            urlwithCriteria += ("<%=api%>".indexOf("?") == -1) ? '?' : '&';
            urlwithCriteria += "where=" + JSON.stringify(where);
            var api = $("#txt<%=fnPrefix%>SearchName").val() == "" ? location.origin + '<%=api%>' : urlwithCriteria;
               
            if(args!==undefined){
                api += (api.indexOf("?") == -1) ? '?' : '&';
                api += 'skip=' + args.skip + '&limit=' + args.limit
                //alert(api);
            }
                        //Initiate ajax
                        console.log("api = " + api);
                        console.log("count = " + api.replace('find','count'));
                        var promiseMasterList = $.when( $.ajax( api ), $.ajax( api.replace('find','count') ) );
                    
                        //var promiseMasterList = $.ajax({ url: api });

                        //callback success
                        promiseMasterList.done(function (res1,res2) { 
                            var res1Data = res1[0];//contains result collection
                            var res2Data = res2[0];//Contain count of records
                            //merge res1Data & res1Data as data with TotalRecordCount
                            var res = {};
                                res.data = res1Data;
                                res.TotalRecords = res2Data.count;
                            //console.log("Result collection = " + JSON.stringify(res));
                            //Data filtered by status "Active"
                            var filtered_<%=fnPrefix%>_Active = _.filter(res.data, function (objData){			
			                        return objData.status == "1";
	                        });
                        
                            //Add class for status dynamically
                            _.each( res.data, function ( item )
                            {
                                item.statusClass = item.status == "1" 
                                                            ? "fa fa-circle vm-fa-green" 
                                                            : "fa fa-circle vm-fa-grey";
                                item.title= item.status == "1" 
                                                            ? "Active" 
                                                            : "Disabled";
			
                            });   
                        //before appending the template empty it
                        $("#<%=fnPrefix%>pc-master-list").empty();
                        $("#tpl-master-list").tmpl(_.sortBy(res.data, "name")).appendTo("#<%=fnPrefix%>pc-master-list");                       
                   
                        //hide the progress bar
                        $.Topic("LoadingImage").publish({ progress: "hide", container: "<%=fnPrefix%>pc-master-list" });
                        //To display tool tip
                        $(".vm-dummy-trunk8").tooltip();

                        //Call for attach Pagination
                         setTimeout(function () {<%=fnPrefix%>AttachPagination(res);},10);
                                            

                        //Attach event handlers
                    
                        $("#<%=fnPrefix%>pc-master-list").on("click", 'i, a', function (args) {
                                args.action = $(this).data( "action" );
                                args.id = $(this).data("id");
                                $.Topic("master-list-row-click_"+args.action).publish(args);  
                         })
                    
                                
                    
                        }); //End of done
   
                         
                        //callback failure
                        promiseMasterList.fail(function () { 
                         //hide the progress bar
                         $.Topic("LoadingImage").publish({ progress: "hide", container: "<%=fnPrefix%>pc-master-list" });
                        console.log("Something went wrong in <%=fnPrefix%>pc-master-list")
                        //TODO: Show noty
                        });    
             },100);//End of setTimeout
    } 
    //-------------------------------------------------------------------------
    <%=fnPrefix%>AttachPagination = function(res) {                          
            var totPages =  Math.ceil(res.TotalRecords/'<%=limit%>') 
            $('#pagination-demo').twbsPagination({
                totalPages: totPages,
                visiblePages : 0,
                first : '<i class="fa fa-angle-double-left"></i>',
                prev : '<i class="fa fa-angle-left"></i>',
                next : '<i class="fa fa-angle-right"></i>',
                last : '<i class="fa fa-angle-double-right"></i>',                     
                onPageClick: function (event, page) {
                    console.log("page = " + page);
                    //if(page!=1){
                        var skip = (page-1) * '<%=limit%>'
                        var args = {};
                        args.skip = skip;
                        args.limit = '<%=limit%>';      
                        eval('<%=fnPrefix%>Master_List_BindData'+'(args)');                    
                 //}
                   
                }
            });    

    }
    
</script>